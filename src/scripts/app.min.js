angular.module("MedwatchApp",["ngSanitize","AppRouter","ngAnimate","toaster","EventBus","HeaderCtrl","HomeCtrl","DetailsCtrl","Search","IconMenu","SearchBox","SearchOverlay","RecallMap","PieChart","LineChart","BarChart"]).controller("MasterController",["$scope","EventBusService",function(e,t){var n=this;n.mobileMenuIsActive=!1,n.mobileMenuPageLoaded=!1,n.toggleMobileMenu=function(e){var t=angular.element(e.target);n.mobileMenuIsActive=t.is("button.mobile-menu-btn")?!n.mobileMenuIsActive:!1},n.closeMobileMenu=function(){n.mobileMenuIsActive=!1},t.subscribe(e,"closeMobileMenu",n.closeMobileMenu),e.$on("$viewContentLoaded",function(){n.mobileMenuPageLoaded=!0})}]),angular.module("AppRouter",["ui.router"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,n){"use strict";t.otherwise("/"),e.state("initialLoad",{url:"/",templateUrl:"src/scripts/app/views/home.html",controller:"HomeController",controllerAs:"home"}),n.html5Mode(!0)}]),angular.module("DetailsCtrl",[]).controller("DetailsController",["$scope","$sce","$sanitize","EventBusService","SearchService",function(e,t,n,r,a){"use strict";e.detailsIsOpen=!1,e.no_results=!1,e.toggleDetails=function(t){e.detailsIsOpen="off"===t?!1:!0},e.notYetImplemented=function(){r.publish("toasterPopup")},r.subscribe(e,"toggleDetails",e.toggleDetails),r.subscribe(e,"badSearch",function(t){e.searchTerm=t,e.no_results=!0}),r.subscribe(e,"updateMapMarkers",function(r){var s=r[0].search_term,i={type:"label",term:"openfda.substance_name:"+s};e.searchTerm=s.slice(0,1).toUpperCase()+s.slice(1).toLowerCase(),a.searchDrugs(i,!0).then(function(r){var a=r.results,s=a[0];e.no_results=!1,e.product_type=s.openfda.product_type?s.openfda.product_type[0]:null,e.generic_name=s.openfda.generic_name?s.openfda.generic_name[0]:null,e.description=s.description?s.description[0]:null,e.indications_and_usage=s.indications_and_usage?s.indications_and_usage[0]:null,e.contraindications=s.contraindications?s.contraindications[0]:null,e.drug_interactions=s.drug_interactions?s.drug_interactions[0]:null,e.dosage_and_administration=s.dosage_and_administration?s.dosage_and_administration[0]:null,e.warnings_table=s.warnings_table?t.trustAsHtml(n(s.warnings_table[0])):s.warnings?s.warnings[0]:null,e.precautions=s.precautions?s.precautions[0]:null,e.routes=[],e.manufacturers=[],a.forEach(function(t){t.openfda.route.forEach(function(t){-1===e.routes.indexOf(t)&&e.routes.push(t)})}),a.forEach(function(t){t.openfda.manufacturer_name.forEach(function(t){-1===e.manufacturers.indexOf(t)&&e.manufacturers.push(t)})})},function(t,n){e.no_results=!0,console.log("Search failed!")})})}]),angular.module("HeaderCtrl",["toaster","ngAnimate","EventBus"]).controller("HeaderController",["$scope","toaster","EventBusService",function(e,t,n){"use strict";this.pop=function(){t.pop({title:"Not Yet Implemented",body:"This feature is not yet implemented."})},n.subscribe(e,"toasterPopup",this.pop)}]),angular.module("HomeCtrl",["EventBus"]).controller("HomeController",["$scope","EventBusService",function(e,t){"use strict";var n=this;n.showLoadingSpinner=!1,t.subscribe(e,"toggleLoadingSpinner",function(e){n.showLoadingSpinner=e})}]),angular.module("NewsfeedCtrl",[]).controller("NewsfeedController",["$scope","EventBusService",function(e,t){"use strict";e.alerts={event:[],enforcement:[],label:[]},e.activeType="enforcement",e.newsfeedIsOpen=!1;var n=function(t){e.activeType="recall"===t?"enforcement":"reaction"===t?"event":"label"};e.isInactive=function(t){return t="recall"===t?"enforcement":"reaction"===t?"event":"label",e.activeType!==t},e.toggleNewsfeed=function(t){return e.isInactive(t)?(e.newsfeedIsOpen===!1&&(e.newsfeedIsOpen=!0),n(t)):void(e.newsfeedIsOpen=!e.newsfeedIsOpen)},t.subscribe(e,"toggleNewsfeed",e.toggleNewsfeed),t.subscribe(e,"updateHeadlines",function(t){t.forEach(function(t){var n=t.data.results,r=n[0];"recall_number"in r?(n.forEach(function(e){var t="";t+=e.city?e.city+", ":"",t+=e.state?e.state+", ":"",t+=e.country,e.address=t}),e.alerts.enforcement=n):"patient"in r?(n.forEach(function(e){var t=Object.keys(e),n=[];t.forEach(function(e){/serious/.test(e)&&n.push(e)}),e.receiptdate=new Date(e.receiptdate.slice(0,4),e.receiptdate.slice(4,6),e.receiptdate.slice(6)),n.indexOf("seriousnessdeath")>-1?e.resultingIn="Resulting in Death":n.indexOf("seriousnessdisabling")>-1?e.resultingIn="Resulting in Disability":n.indexOf("seriousnesshospitalization")>-1?e.resultingIn="Resulting in Hospitalization":n.indexOf("seriousnesslifethreatening")>-1?e.resultingIn="Resulting in a Life-threatening Condition":n.indexOf("seriousnesscongenitalanomali")>-1&&(e.resultingIn="Resulting in a Congenital Anomali")}),e.alerts.event=n):e.alerts.label=n})})}]),angular.module("EventBus",[]).factory("EventBusService",["$rootScope",function(e){"use strict";function t(t,n){e.$broadcast(t,n)}function n(e,t,n){e.$on(t,function(e,t){n(t)})}return{publish:t,subscribe:n}}]),angular.module("Search",[]).factory("SearchService",["$http","$q","EventBusService",function(e,t,n){"use strict";function r(e,t,n){var r,a,s;return!e||!e.results,a=e.results[0],s=Object.keys(a),n=n?n:s.indexOf("patient")>-1?"event":s.indexOf("recalling_firm")>-1?"enforcement":"label",r="event"===n?e.results.map(function(e){var n=Object.keys(e),r=[];return n.forEach(function(e){/serious/.test(e)&&r.push(e)}),e.receiptdate=new Date(e.receiptdate.slice(0,4),e.receiptdate.slice(4,6),e.receiptdate.slice(6)),r.indexOf("seriousnessdeath")>-1?e.resultingIn="Resulting in Death":r.indexOf("seriousnessdisabling")>-1?e.resultingIn="Resulting in Disability":r.indexOf("seriousnesshospitalization")>-1?e.resultingIn="Resulting in Hospitalization":r.indexOf("seriousnesslifethreatening")>-1?e.resultingIn="Resulting in a Life-threatening Condition":r.indexOf("seriousnesscongenitalanomali")>-1&&(e.resultingIn="Resulting in a Congenital Anomali"),e.search_term=t,e}):"enforcement"===n?e.results.map(function(e){return{search_term:t,city:e.city,state:e.state,country:e.country,product_description:e.product_description,reason_for_recall:e.reason_for_recall,code_info:e.code_info,recall_name:e.openfda.brand_name||e.openfda.substance_name||e.openfda.generic_name||null,recalling_firm:e.recalling_firm}}):$.extend(!0,{},e.results,{search_term:t})}function a(n,r){var a,s,c,l,u,p,m=n.type,d=n.term,f=n.limit,g=(n.skip,n.count,n.fromDate),h=n.toDate;if("event"===m||"label"===m||"enforcement"===m){switch(m){case"event":s="patient.drug.openfda.",c="receivedate:";break;case"label":s="openfda.",c="effective_time:";break;case"enforcement":s="openfda.",c="report_date:"}return null!==f&&(f=f||20),g&&(l=c+"["+g+"+TO+",h?l+=h+"]":(u=new Date,l+=u.getFullYear()+(u.getMonth()+1<10?"0"+(u.getMonth()+1):u.getMonth())+(u.getDate()<10?"0"+u.getDate():u.getDate()),l+="]")),a=r?d:s+"brand_name:"+d+"+OR+"+s+"substance_name:"+d+"+OR+"+s+"manufacturer_name:"+d+"+OR+"+s+"generic_name:"+d,"enforcement"!==m||r||n.count?"label"!==m||r||n.count||(a+="+OR+spl_product_data_elements:"+d):a+="+OR+product_description:"+d,a="("+a+")"+(l?"+AND+"+l:""),p=o+"drug/"+m+".json?api_key="+i+"&search="+a+(null===f?"":"&limit="+f),n.count&&(p+="&count="+n.count),t(function(t,n){e.get(p).success(function(e){t(e)}).error(function(e,t){n(e,t)})})}}function s(n){var r,a,s=n.type,c=n.limit,l=(n.skip,n.city,n.state);return"enforcement"===s?(a="state:"+l,c=c||20,r=o+"drug/"+s+".json?api_key="+i+"&search="+a+"&limit="+c,t(function(t,n){e.get(r).success(function(e){t(e)}).error(function(e,t){n(e,t)})})):void 0}var i="MzPnC5U3ET5CKXrmWrfBxh7YSIhSmZVw2Ao2upAq",o="https://api.fda.gov/";return{searchDrugs:a,searchDrugsByLocation:s,massageData:r}}]),angular.module("BarChart",["EventBus"]).directive("barChart",["EventBusService","SearchService",function(e,t){"use strict";return{restrict:"E",replace:!0,templateUrl:"src/scripts/app/views/bar-chart.html",link:function(n,r,a){n.barPaper=Raphael("serious-nonserious-chart"),e.subscribe(n,"updateMapMarkers",function(e){var r={type:"event",term:e[0].search_term,count:"serious",limit:null};n.searchTerm=r.term.slice(0,1).toUpperCase()+r.term.slice(1).toLowerCase(),t.searchDrugs(r).then(function(e){var t,r,a,s;e&&e.results&&(t=e.results,r=t.map(function(e){return e.count}),a=t.map(function(e){return 1===e.term?"Serious":"Non-Serious"}),n.barPaper.clear(),s=n.barPaper.barchart(0,0,220,200,r,{legend:a}),s.hover(function(){var e=this.bar.value,t=this.bar.value===r[0]?" serious ":" non-serious ";this.flag=n.barPaper.popup(this.bar.x,this.bar.y,e+t+"reactions").insertBefore(this)},function(){this.flag&&this.flag.animate({opacity:0},300,function(){this.remove()})}))})})}}}]),angular.module("IconMenu",[]).directive("iconMenu",function(){"use strict";return{restrict:"E",replace:!0,templateUrl:"src/scripts/app/views/icon-menu.html",controller:["$scope","EventBusService",function(e,t){e.isActiveButton=function(t){return e.activeButton===t},e.toggleDetails=function(n,r){e.activeButton=angular.element(n.target).attr("id"),t.publish("toggleDetails",r)},e.activeButton="recall-btn"}]}}),angular.module("LineChart",["EventBus"]).directive("lineChart",["EventBusService","SearchService",function(e,t){"use strict";return{restrict:"E",replace:!0,templateUrl:"src/scripts/app/views/line-chart.html",link:function(n,r,a){n.lineChart=Raphael("reactions-over-time-chart"),n.numYears=2,e.subscribe(n,"updateMapMarkers",function(e){var r="patient.drug.openfda.",a=new Date(Date.now()),s=new Date(a.getFullYear()-n.numYears,a.getMonth(),a.getDate()),i=""+a.getFullYear()+(a.getMonth()+1<10?"0"+(a.getMonth()+1):a.getMonth()+1)+(a.getDate()<10?"0"+a.getDate():a.getDate()),o=""+s.getFullYear()+(s.getMonth()+1<10?"0"+(s.getMonth()+1):s.getMonth()+1)+(s.getDate()<10?"0"+s.getDate():s.getDate()),c=e[0].search_term,l="("+r+"brand_name:"+c+"+"+r+"substance_name:"+c+"+"+r+"manufacturer_name:"+c+"+"+r+"generic_name:"+c+")+AND+receivedate:["+o+"+TO+"+i+"]",u={type:"event",term:l,count:"receivedate",limit:null};n.searchTerm=c.slice(0,1).toUpperCase()+c.slice(1).toLowerCase(),t.searchDrugs(u,!0).then(function(e){var t,r,a,s;e&&e.results&&(t=e.results.sort(function(e,t){var n=+e.time,r=+t.time;return r>n?1:n>r?-1:0}).slice(0,30),a=t.map(function(e){return e.count}),r=t.map(function(e){return+e.time}),n.lineChart.clear(),s=n.lineChart.linechart(10,10,220,180,r,a,{nostroke:!1,axis:"0 0 1 1",symbol:"",smooth:!1}))})})}}}]),angular.module("PieChart",["EventBus"]).directive("pieChart",["EventBusService","SearchService",function(e,t){"use strict";return{restrict:"E",replace:!0,templateUrl:"src/scripts/app/views/pie-chart.html",link:function(n,r,a){n.piePaper=Raphael("frequent-reactions-chart"),n.numResults=5,e.subscribe(n,"updateMapMarkers",function(e){var r={type:"event",term:e[0].search_term,limit:n.numResults,count:"patient.reaction.reactionmeddrapt.exact"};n.searchTerm=r.term.slice(0,1).toUpperCase()+r.term.slice(1).toLowerCase(),t.searchDrugs(r).then(function(e){var t,r,a,s;e&&e.results&&(t=e.results,r=t.map(function(e){return e.count}),a=t.map(function(e){return e.term+" - %%.%%"}),n.piePaper.clear(),s=n.piePaper.piechart(100,100,80,r,{legend:a,colors:["#7B95C9","#457fea","#E5DDC6","#A5D842","#06b8a7"]}),s.hover(function(){this.sector.stop(),this.sector.animate({transform:"s1.1 1.1 "+this.cx+" "+this.cy},400,"ease-out"),this.flag=n.piePaper.popup((this.cx+this.mx)/2,(this.cy+this.my)/2,this.sector.value+" cases")},function(){this.sector.stop(),this.sector.animate({transform:"S1 1 "+this.cx+" "+this.cy},400,"ease-out"),this.flag&&this.flag.animate({opacity:0},300,function(){this.remove()})}))})})}}}]),angular.module("RecallMap",["EventBus"]).directive("recallMap",["$window","$timeout","EventBusService",function(e,t,n){"use strict";function r(e,t){var n;e.address=e.state?e.state:e.country,e.city&&(e.address=e.address?e.city+", "+e.address:e.city),n=e.address,s[n]?(e.latLng=s[n],t()):a.geocode({address:n},function(r,a){var i=google.maps.GeocoderStatus;a===i.OK?(e.latLng=r[0].geometry.location,s[n]=new google.maps.LatLng(e.latLng.lat(),e.latLng.lng())):a===i.ZERO_RESULTS?console.warn("Warning: Zero results for the provided address: "+n):console.error("Error: Geocoding service returned: "+a),t()})}var a=new google.maps.Geocoder,s={},i=[];return{restrict:"E",template:"<div></div>",replace:!0,controller:["$scope","EventBusService",function(e,n){n.subscribe(e,"updateMapMarkers",function(a){function s(){var n,r,a,o,c=m.shift();c&&(c.latLng?(n=new google.maps.Marker({position:c.latLng,animation:google.maps.Animation.DROP,map:e.map}),i.push(n),n.setMap(e.map),a='<article id="recall-notice-'+c.id+'">',a+=null!==c.recall_name?"<h1>"+c.recall_name+'</h1><span class="recall-notice-subtitle">'+c.recalling_firm+"</span>":"<h1>"+c.recalling_firm+'</h1><span class="recall-notice-subtitle">'+c.city+", "+c.state+"</span>",a+='<div class="recall-notice-details"><h5>Affected Products:</h5><span class="recall-notice-lot-numbers">'+c.code_info+'</span><p class="recall-notice-product-description">'+c.product_description+'</p><h5>Reason for Recall:</h5><p class="recall-notice-reason-for-recall">'+c.reason_for_recall+'</p><a class="see-full-report" ng-click="notYetImplemented()">See Full Report</a></div></article>',c.search_term&&(o=new RegExp("("+c.search_term+")","ig"),a=a.replace(o,"<b>$1</b>")),r=new google.maps.InfoWindow({content:a}),google.maps.event.addListener(n,"click",function(){p&&p.close(),r.open(e.map,n),p=r}),t(s,100)):s())}function o(){u++,u>=l&&(n.publish("toggleLoadingSpinner",!1),s())}function c(e,n){n++,r(e,o),n<m.length&&t(function(){c(m[n],n)},100)}var l=a.length,u=0,p=null,m=a.slice();i.forEach(function(e){e.setMap(null)}),i=[],c(m[0],0)})}],link:function(e,t,r){function a(){var t={styles:[{featureType:"administrative.country",elementType:"all",stylers:[{visibility:"on"},{color:"#14c7c7"}]},{featureType:"administrative.country",elementType:"geometry",stylers:[{visibility:"on"},{color:"#617995"}]},{featureType:"administrative.country",elementType:"labels.text",stylers:[{color:"#212f4f"}]},{featureType:"administrative.country",elementType:"labels.text.stroke",stylers:[{visibility:"off"}]},{featureType:"landscape.natural.landcover",elementType:"geometry",stylers:[{hue:"#ff0000"},{lightness:"25"}]},{featureType:"landscape.natural.landcover",elementType:"geometry.fill",stylers:[{hue:"#00ffd5"}]},{featureType:"landscape.natural.landcover",elementType:"labels.text.stroke",stylers:[{visibility:"simplified"},{hue:"#ff0000"}]},{featureType:"landscape.natural.terrain",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#baca7c"}]},{featureType:"water",elementType:"all",stylers:[{visibility:"on"},{color:"#87a6bc"}]}]},n=new google.maps.Map(document.getElementById(r.id),t),a=new google.maps.LatLngBounds(new google.maps.LatLng(22.49225744817961,-137.6269535),new google.maps.LatLng(49.33944109801259,-63.79882850000001));e.map=n,google.maps.event.addListenerOnce(n,"bounds_changed",function(){n.setZoom(n.getZoom()+1)}),n.fitBounds(a)}var s=angular.element(t);s.on("click","a.see-full-report",function(){n.publish("toasterPopup")}),a()}}}]),angular.module("SearchBox",["Search"]).directive("searchBox",function(){"use strict";return{restrict:"E",replace:!0,scope:{},templateUrl:"src/scripts/app/views/search-box.html",controller:["$scope","$timeout","SearchService","EventBusService",function(e,t,n,r){var a=new google.maps.Geocoder;e.submitSearch=function(t){var s,i,o={},c=!1,l=angular.element(t.target),u=l.closest("#mobile-menu").length>0;e.searchTerm=e.searchTerm?e.searchTerm.trim():"",e.fixedSearchTerm=e.searchTerm.slice(),r.publish("toggleLoadingSpinner",!0),s=new Date(e.fromDate),i=e.toDate?new Date(e.toDate):"",c=isNaN(s.getTime())||""!==i&&isNaN(i.getTime()),c||(o.fromDate=""+s.getFullYear()+(s.getMonth()+1<10?"0"+(s.getMonth()+1):s.getMonth())+(s.getDate()<10?"0"+s.getDate():s.getDate()),i&&(o.toDate=""+i.getFullYear()+(i.getMonth()+1<10?"0"+(i.getMonth()+1):i.getMonth())+(i.getDate()<10?"0"+i.getDate():i.getDate()))),u&&document.activeElement.blur(),/^\d{5}$|^\d{5}-\d{4}$/.test(e.searchTerm)?a.geocode({address:e.searchTerm},function(t){var a=t[0].formatted_address,s=a.split(", "),i=s.shift(),c=s.shift().split(" ").shift();o=$.extend(o,{type:"enforcement",city:i,state:c}),n.searchDrugsByLocation(o).then(function(t){var a=n.massageData(t,e.searchTerm,"enforcement");e.no_results=!1,u&&r.publish("closeMobileMenu"),r.publish("updateMapMarkers",a)},function(t,n){e.no_results=!0,r.publish("badSearch",e.searchTerm),r.publish("toggleLoadingSpinner",!1),console.error("Error searching for drugs.")})}):(o=$.extend(o,{type:"enforcement",term:e.searchTerm}),n.searchDrugs(o).then(function(t){var a=n.massageData(t,e.searchTerm,"enforcement");e.no_results=!1,u&&r.publish("closeMobileMenu"),r.publish("updateMapMarkers",a)},function(t,n){e.no_results=!0,r.publish("badSearch",e.searchTerm),r.publish("toggleLoadingSpinner",!1),console.error("Error searching for drugs.")})),console.log("Search submitted!")},e.$watch("no_results",function(n){n===!0&&t(function(){e.no_results=!1},4e3)})}]}}),angular.module("SearchOverlay",["Search","EventBus"]).directive("searchOverlay",function(){"use strict";return{restrict:"E",replace:!0,templateUrl:"src/scripts/app/views/search-overlay.html",scope:{},controller:["$scope","$timeout","SearchService","EventBusService",function(e,t,n,r){e.submitSearch=function(t){e.searchTerm=e.searchTerm?e.searchTerm.trim():"",e.fixedSearchTerm=e.searchTerm.slice(),r.publish("toggleLoadingSpinner",!0);var a=angular.element(t.target),s={type:"enforcement",term:e.searchTerm,limit:20,skip:0};"100%"===a.closest(".inner-section").css("height")&&"100%"===a.closest(".inner-section").css("width")&&document.activeElement.blur(),n.searchDrugs(s).then(function(t){var a=n.massageData(t,s.term,s.type);e.shouldHide=!0,e.no_results=!1,r.publish("updateMapMarkers",a)},function(){e.no_results=!0,r.publish("badSearch",e.searchTerm),r.publish("toggleLoadingSpinner",!1)})},r.subscribe(e,"closeMobileMenu",function(){e.shouldHide=!0}),e.notYetImplemented=function(){r.publish("toasterPopup")},e.$watch("no_results",function(n){n===!0&&t(function(){e.no_results=!1},4e3)})}],link:function(e,t){var n=t.closest("body");e.no_results=!1,e.$watch("shouldHide",function(e){e===!0?n.removeClass("overlay-visible"):n.addClass("overlay-visible")})}}});